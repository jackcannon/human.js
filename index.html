<!doctype html>
<html>
  <head>
    <title>Human.js</title>
    <link rel="icon" href="img/logo-smaller.png" type="image/png">
    <link href='http://fonts.googleapis.com/css?family=Poiret+One|Ubuntu|Josefin+Slab|Julius+Sans+One' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="css/main.css">
  </head>
  <body>
    <canvas id="display"></canvas>
    <div id="controls">
      <textarea id="input"></textarea>
      <input type="button" value="Go" id="go"></input>
    </div>

    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="https://raw.github.com/caolan/async/master/lib/async.js"></script>
    <script src="http://cloud.github.com/downloads/processing-js/processing-js/processing-1.4.1.min.js"></script>
    <script src="js/human.js"></script>

    <script>
      var box = [];

      var Jack = new Human({
        name: 'Jack',
        gender: 'male',
        x: -100,
        y: 0
      });
      var Amanda = new Human({
        name: 'Amanda',
        gender: 'female',
        orientation: 'left',
        x: 100,
        y: 0
      });


      function doProcessing(processing) {

        processing.setup = function() {
          font = processing.createFont('Julius Sans One');
          processing.textFont(font, 18);
        }

        processing.draw = function () {
          processing.size($('#display').width(), $('#display').height());
          processing.background(255);

          var centreX = processing.width / 2;
          var centreY = processing.height / 2;

          function crosshair() {
            processing.fill(128 , 128 , 128);
            processing.stroke(128 , 128 , 128);
            processing.strokeWeight(1);
            var shift = -2;
            processing.line(centreX + shift, centreY - 10 + shift, centreX + shift, centreY + 10 + shift);
            processing.line(centreX - 10 + shift, centreY + shift, centreX + 10 + shift, centreY + shift);
          }

          function getPoint(baseX, baseY, long, angle) {
            var x = baseX + Math.sin(angle * 2 * Math.PI) * long;
            var y = baseY - Math.cos(angle * 2 * Math.PI) * long;

            return {x: x, y: y}
          }

          function getPointFromObj(obj, list, base) {
            if(obj.connects instanceof Array && obj.connects.length > 0) {
              var base = getPointFromObj(list[obj.connects[0]], list, base);
              return getPoint(base.x, base.y, obj.long, obj.angle);
            } else {
              return getPoint(base.x, base.y, obj.long, obj.angle);
            }
          }

          function drawPoint(x, y, gender) { //dont apply centreX/centreY, do apply obj.x/obj.y beforehand
            if(gender == 'male') {
              processing.fill(200 , 200 , 255);
              processing.stroke(200 , 200 , 255);
              processing.strokeWeight(1);
            } else if (gender == 'female') {
              processing.fill(255 , 210 , 210);
              processing.stroke(255 , 210 , 210);
              processing.strokeWeight(1);
            }

            var pointX = centreX + x - 2;
            var pointY = centreY + y - 2;

            processing.ellipse(pointX, pointY, 4, 4);
          }

          function drawLine(x1, y1, x2, y2, gender) {
            if (gender == 'male') {
              processing.fill(150 , 150 , 255);
              processing.stroke(150 , 150 , 255);
            } else if (gender == 'female') {
              processing.fill(255 , 175 , 175);
              processing.stroke(255 , 175 , 175);
            }
            processing.strokeWeight(2);
            processing.line(centreX + x1 - 2, centreY + y1 - 2, centreX + x2 - 2, centreY + y2 - 2);
          }

          function text(x,y,text,gender,type) { // type == 'header' || 'speech'
            if(gender == 'male') {
              processing.fill(150 , 150 , 255);
              processing.stroke(150 , 150 , 255);
            } else {
              processing.fill(255 , 175 , 175);
              processing.stroke(255 , 175 , 175);
            }
            if(type == 'header') {
              font = processing.createFont('Ubuntu');
              processing.textFont(font, 14);
            } else if (type == 'speech') {
              font = processing.createFont('Ubuntu');
              processing.textFont(font, 11);
            }

            processing.textAlign('CENTER', 'CENTER');
            var textWidth = processing.textWidth(text);
            processing.text( text , centreX + x - (textWidth / 2) - 2 , centreY + y - 2 );
          }

          // crosshair();

          for (var obj in box) {
            for(var p in box[obj].points) {
              var info = box[obj].points[p];
              for(var co in info.connects) {
                var base = box[obj].points[info.connects[co]];
                var bp = getPointFromObj(base, box[obj].points, box[obj]);
                var ip = getPointFromObj(info, box[obj].points, box[obj]);
                drawLine(bp.x, bp.y, ip.x, ip.y, box[obj].gender);
              }
            }

            for(var p in box[obj].points) {
              var info = box[obj].points[p];
              if (info.connects.length > 0) {
                var base = getPointFromObj(box[obj].points[info.connects[0]], box[obj].points, box[obj]);
              } else {
                var base = {
                  x: box[obj].x,
                  y: box[obj].y
                }
              }
              var ip = getPointFromObj(info, box[obj].points, box[obj]);
              drawPoint( ip.x , ip.y , box[obj].gender);
            }

            //do text
            var crown = getPointFromObj(box[obj].points.crown, box[obj].points, box[obj]);
            text(crown.x, crown.y - 30, box[obj].name, box[obj].gender, 'header');
            text(crown.x, crown.y - 15, box[obj].saying, box[obj].gender, 'speech');
          }
        }
      }


      var canvas = document.getElementById("display");
      var processingInstance = new Processing(canvas, doProcessing);

      var execute = function () {
        return function() {
          var stuff = eval($('#input').val());
          // if(stuff) console.log(stuff);
        }.bind(Jack)();
      }

      $('#go').click(execute);

      $("#input, #display").hover(
        function () {
          $('#input').css({"border-top": "2px dashed #AAAAFF"});
        },
        function () {
          $('#input').css({"border-top": "2px dashed #EEEEFF"});
        }
      );

      $('#input').keydown(function (e) {
        if (e.keyCode == 13 && e.shiftKey) {
          execute();
          e.preventDefault();
        }
        if (e.keyCode == 9) {
          // $('#input').val($('#input').val() + '  ');
          // console.log($('#input').caret().start);
          e.preventDefault();
        }
      });



      var putHumansInBox = function() {
        for(var v in window) {
          if(window[v] instanceof Human && ($.inArray(window[v], box) === -1)) {
            window[v].universe = box;
            box.push(window[v]);
          }
        }
      }
      putHumansInBox();
      var boxLoop = setInterval(putHumansInBox, 500);

    </script>

  </body>
</html>